name: å¤šå¹³å°æ„å»º

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-2022
            platform: windows
            arch: x64
            ext: .exe
            name: Windows
            icon: ğŸªŸ
          - os: macos-latest
            platform: macos
            arch: x64
            ext: ""
            name: macOS
            icon: ğŸ
          - os: ubuntu-latest
            platform: linux
            arch: x64
            ext: ""
            name: Linux
            icon: ğŸ§

    steps:
      - name: ${{ matrix.icon }} æ£€å‡ºä»£ç  (${{ matrix.name }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        shell: bash
        run: |
          echo "TAG_NAME=${{github.ref_name}}" >> $GITHUB_ENV
          if git describe --tags --abbrev=0 HEAD^ 2>/dev/null; then
            echo "PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)" >> $GITHUB_ENV
          else
            echo "PREV_TAG=" >> $GITHUB_ENV
          fi

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          # ç”Ÿæˆå”¯ä¸€çš„è®¿é—®ç»Ÿè®¡IDï¼ˆç§»é™¤ç‚¹å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
          VIEW_COUNTER_ID=$(echo "11273-mooc-work-answer-${{ env.TAG_NAME }}" | sed 's/[^a-zA-Z0-9-]/-/g')
          
          badge1="[![GitHub Release](https://img.shields.io/github/v/release/11273/mooc-work-answer?style=flat-square&logo=github&color=blue)](https://github.com/11273/mooc-work-answer/releases/tag/${{ env.TAG_NAME }})"
          badge2="[![ä¸‹è½½ç»Ÿè®¡](https://img.shields.io/github/downloads/11273/mooc-work-answer/${{ env.TAG_NAME }}/total?style=flat-square&logo=github&color=green)](https://github.com/11273/mooc-work-answer/releases/tag/${{ env.TAG_NAME }})"
          badge3="[![è®¿é—®ç»Ÿè®¡](https://komarev.com/ghpvc/?username=${VIEW_COUNTER_ID}&label=Views&style=flat-square&color=brightgreen)](https://github.com/11273/mooc-work-answer/releases/tag/${{ env.TAG_NAME }})"
          header="## ğŸš€ ç‰ˆæœ¬æ›´æ–° ${{ env.TAG_NAME }}"
          
          # è·å–æäº¤æ—¥å¿—å¹¶æ ¼å¼åŒ– - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
          if [ "${{ env.PREV_TAG }}" ]; then
            # ä½¿ç”¨æ ‡ç­¾ä¹‹é—´çš„æäº¤èŒƒå›´ï¼Œç¡®ä¿åŒ…å«æ‰€æœ‰æäº¤
            log=$(git rev-list ${{ env.PREV_TAG }}..${{ env.TAG_NAME }} --pretty=format:"- %s" --no-merges | grep "^-" | head -20)
            # å¦‚æœä¸Šé¢çš„å‘½ä»¤æ²¡æœ‰ç»“æœï¼Œå›é€€åˆ°åŸæ–¹æ³•
            if [ -z "$log" ]; then
              log=$(git log ${{ env.PREV_TAG }}..HEAD --pretty=format:"- %s" --no-merges | head -20)
            fi
          else
            log=$(git log --pretty=format:"- %s" --no-merges | head -10)
          fi
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          platforms="### ğŸ“¦ æ”¯æŒå¹³å°\n- ğŸªŸ **Windows**: æ”¯æŒ Windows 7/8/10/11 (x64)\n- ğŸ **macOS**: æ”¯æŒ macOS 10.14+ (Intel & Apple Silicon)\n- ğŸ§ **Linux**: æ”¯æŒä¸»æµ Linux å‘è¡Œç‰ˆ (x64)"
          changelog="${badge1} ${badge2} ${badge3}\n\n${header}\n\n### ğŸ“‹ æ›´æ–°å†…å®¹\n${log}\n\n${platforms}\n\n### ğŸ’¾ ä¸‹è½½è¯´æ˜\n- **Windows**: ç›´æ¥ä¸‹è½½ \`.exe\` æ–‡ä»¶è¿è¡Œ\n- **macOS**: ç›´æ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ç»ˆç«¯è¿è¡Œ\n- **Linux**: ç›´æ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œ\n\n### ğŸ”§ ä½¿ç”¨æ–¹æ³•\n1. æ ¹æ®æ‚¨çš„ç³»ç»Ÿä¸‹è½½å¯¹åº”ç‰ˆæœ¬ï¼ˆæ— éœ€è§£å‹ï¼‰\n2. **Windows**: åŒå‡»è¿è¡Œ \`.exe\` æ–‡ä»¶\n3. **macOS**: æ‰“å¼€ç»ˆç«¯ï¼Œæ‹–æ‹½æ–‡ä»¶åˆ°ç»ˆç«¯çª—å£ï¼Œç„¶åæŒ‰å›è½¦\n4. **Linux**: åœ¨ç»ˆç«¯ä¸­è¿è¡Œ \`./filename\`\n5. æŒ‰ç…§æç¤ºè¾“å…¥è´¦å·ä¿¡æ¯ï¼Œé€‰æ‹©éœ€è¦çš„åŠŸèƒ½å¼€å§‹ä½¿ç”¨\n\n### ğŸ’¡ macOS ä½¿ç”¨æç¤º\n- ä¸‹è½½åå¦‚æœå‡ºç°æƒé™é”™è¯¯ï¼Œå…ˆè¿è¡Œ: \`chmod +x filename\`\n- ç„¶åç›´æ¥æ‹–æ‹½æ–‡ä»¶åˆ°ç»ˆç«¯çª—å£å³å¯è¿è¡Œ\n- æˆ–è€…åœ¨ç»ˆç«¯ä¸­ cd åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œç„¶åè¿è¡Œ \`./filename\`"
          
          echo -e "$changelog" > changelog.txt

      - name: æ³¨å…¥ç¯å¢ƒå˜é‡ (Specæ–‡ä»¶)
        if: matrix.platform == 'windows'
        uses: NicoG60/simple-template-renderer@v1
        with:
          input: StartWorkLite.spec
        env:
          PYINSTALL_KEY: ${{ secrets.PYINSTALL_KEY }}
          TAG_NAME: ${{ env.TAG_NAME }}

      - name: æ³¨å…¥ç¯å¢ƒå˜é‡ (Pythonæ–‡ä»¶)
        uses: NicoG60/simple-template-renderer@v1
        with:
          input: StartWork.py
        env:
          TAG_NAME: ${{ env.TAG_NAME }}

      - name: ${{ matrix.icon }} æ˜¾ç¤ºæ„å»ºä¿¡æ¯ (${{ matrix.name }})
        shell: bash
        run: |
          echo "======================================"
          echo "${{ matrix.icon }} æ„å»ºä¿¡æ¯ - ${{ matrix.name }}"
          echo "======================================"
          echo "å¹³å°: ${{ matrix.platform }}"
          echo "æ¶æ„: ${{ matrix.arch }}"
          echo "è¿è¡Œå™¨: ${{ matrix.os }}"
          echo "ä¸Šä¸€ç‰ˆæœ¬: ${{ env.PREV_TAG }}"
          echo "å½“å‰ç‰ˆæœ¬: ${{ env.TAG_NAME }}"
          echo "======================================"

      - name: é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: å®‰è£…æ„å»ºä¾èµ–
        shell: bash
        run: |
          python -m pip install --upgrade pip
          # ä½¿ç”¨æ›´æ–°çš„ PyInstaller ç‰ˆæœ¬è§£å†³ macOS ä»£ç ç­¾åé—®é¢˜
          if [ "${{ matrix.platform }}" = "macos" ]; then
            pip install pyinstaller==5.13.2
          else
            pip install pyinstaller==4.5
          fi
          pip install wheel
          pip install tinyaes
          pip install -r requirements.txt

      - name: ${{ matrix.icon }} æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (${{ matrix.name }})
        shell: bash
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º ${{ matrix.name }} å¯æ‰§è¡Œæ–‡ä»¶..."
          
          if [ "${{ matrix.platform }}" = "windows" ]; then
            pyinstaller StartWorkLite.spec
          else
            # Linux æ„å»º
            pyinstaller --onefile \
              --name "MoocWorkAnswer-${{ env.TAG_NAME }}-lite-${{ matrix.platform }}" \
              --distpath dist \
              --workpath build \
              --specpath . \
              --console \
              StartWork.py
          fi
          
          echo "âœ… ${{ matrix.name }} æ„å»ºå®Œæˆ"

      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          if ls dist/* 1> /dev/null 2>&1; then
            echo "âœ… ${{ matrix.name }} æ„å»ºæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            ls -la dist/
          else
            echo "âŒ ${{ matrix.name }} æ„å»ºæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: é‡å‘½åè¾“å‡ºæ–‡ä»¶å¹¶è®¾ç½®æƒé™
        shell: bash
        run: |
          cd dist
          for file in *; do
            if [ -f "$file" ]; then
              # è·å–æ–‡ä»¶æ‰©å±•å
              if [ "${{ matrix.platform }}" = "windows" ]; then
                ext=".exe"
              else
                ext=""
              fi
              
              # ç»Ÿä¸€æ–‡ä»¶åæ ¼å¼
              new_name="MoocWorkAnswer-${{ env.TAG_NAME }}-lite-${{ matrix.platform }}${ext}"
              
              # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å·²ç»æ˜¯ç›®æ ‡åç§°
              if [ "$file" != "$new_name" ]; then
                mv "$file" "$new_name"
                echo "âœ… æ–‡ä»¶é‡å‘½å: $file -> $new_name"
              else
                echo "â„¹ï¸ æ–‡ä»¶åå·²æ­£ç¡®ï¼Œè·³è¿‡é‡å‘½å: $file"
              fi
              
              # ä¸º macOS å’Œ Linux è®¾ç½®æ‰§è¡Œæƒé™å’Œæ–‡ä»¶å±æ€§
              if [ "${{ matrix.platform }}" != "windows" ]; then
                chmod +x "$new_name"
                echo "âœ… å·²è®¾ç½®æ‰§è¡Œæƒé™: $new_name"
                
                # macOS ç‰¹æ®Šå¤„ç†ï¼šè®¾ç½®æ–‡ä»¶ç±»å‹
                if [ "${{ matrix.platform }}" = "macos" ]; then
                  # ç¡®ä¿æ–‡ä»¶è¢«è¯†åˆ«ä¸º Unix å¯æ‰§è¡Œæ–‡ä»¶
                  file "$new_name"
                  ls -la "$new_name"
                fi
              fi
            fi
          done

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 1
          # å°è¯•ä¿æŒæ–‡ä»¶æƒé™
          include-hidden-files: true

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          find artifacts -name "*" -type f -exec cp {} release-files/ \;
          
          # ç¡®ä¿ macOS å’Œ Linux æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          cd release-files
          for file in *; do
            if [[ "$file" != *.exe ]]; then
              chmod +x "$file"
              echo "âœ… è®¾ç½®æ‰§è¡Œæƒé™: $file"
              
              # æ£€æŸ¥ macOS æ–‡ä»¶
              if [[ "$file" == *"macos"* ]]; then
                echo "ğŸ macOS æ–‡ä»¶ä¿¡æ¯:"
                file "$file" || echo "file å‘½ä»¤ä¸å¯ç”¨"
                ls -la "$file"
              fi
            fi
          done
          
          echo "ğŸ“¦ æ‰€æœ‰å‘å¸ƒæ–‡ä»¶:"
          ls -la

      - name: è·å–æ›´æ–°æ—¥å¿—
        run: |
          # é‡æ–°ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆå› ä¸ºéœ€è¦åœ¨release jobä¸­ä½¿ç”¨ï¼‰
          TAG_NAME=${{github.ref_name}}
          if git describe --tags --abbrev=0 HEAD^ 2>/dev/null; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)
            # ä½¿ç”¨æ ‡ç­¾ä¹‹é—´çš„æäº¤èŒƒå›´ï¼Œç¡®ä¿åŒ…å«æ‰€æœ‰æäº¤
            log=$(git rev-list ${PREV_TAG}..${TAG_NAME} --pretty=format:"- %s" --no-merges | grep "^-" | head -20)
            # å¦‚æœä¸Šé¢çš„å‘½ä»¤æ²¡æœ‰ç»“æœï¼Œå›é€€åˆ°åŸæ–¹æ³•
            if [ -z "$log" ]; then
              log=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -20)
            fi
          else
            log=$(git log --pretty=format:"- %s" --no-merges | head -10)
          fi
          
          # ç”Ÿæˆå”¯ä¸€çš„è®¿é—®ç»Ÿè®¡IDï¼ˆç§»é™¤ç‚¹å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
          VIEW_COUNTER_ID=$(echo "11273-mooc-work-answer-${TAG_NAME}" | sed 's/[^a-zA-Z0-9-]/-/g')
          
          badge1="[![GitHub Release](https://img.shields.io/github/v/release/11273/mooc-work-answer?style=flat-square&logo=github&color=blue)](https://github.com/11273/mooc-work-answer/releases/tag/${TAG_NAME})"
          badge2="[![ä¸‹è½½ç»Ÿè®¡](https://img.shields.io/github/downloads/11273/mooc-work-answer/${TAG_NAME}/total?style=flat-square&logo=github&color=green)](https://github.com/11273/mooc-work-answer/releases/tag/${TAG_NAME})"
          badge3="[![è®¿é—®ç»Ÿè®¡](https://komarev.com/ghpvc/?username=${VIEW_COUNTER_ID}&label=Views&style=flat-square&color=brightgreen)](https://github.com/11273/mooc-work-answer/releases/tag/${TAG_NAME})"
          header="## ğŸš€ ç‰ˆæœ¬æ›´æ–° ${TAG_NAME}"
          platforms="### ğŸ“¦ æ”¯æŒå¹³å°\n- ğŸªŸ **Windows**: æ”¯æŒ Windows 7/8/10/11 (x64)\n- ğŸ **macOS**: æ”¯æŒ macOS 10.14+ (Intel & Apple Silicon)\n- ğŸ§ **Linux**: æ”¯æŒä¸»æµ Linux å‘è¡Œç‰ˆ (x64)"
          changelog="${badge1} ${badge2} ${badge3}\n\n${header}\n\n### ğŸ“‹ æ›´æ–°å†…å®¹\n${log}\n\n${platforms}\n\n### ğŸ’¾ ä¸‹è½½è¯´æ˜\n- **Windows**: ç›´æ¥ä¸‹è½½ \`.exe\` æ–‡ä»¶è¿è¡Œ\n- **macOS**: ç›´æ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ç»ˆç«¯è¿è¡Œ\n- **Linux**: ç›´æ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œ\n\n### ğŸ”§ ä½¿ç”¨æ–¹æ³•\n1. æ ¹æ®æ‚¨çš„ç³»ç»Ÿä¸‹è½½å¯¹åº”ç‰ˆæœ¬ï¼ˆæ— éœ€è§£å‹ï¼‰\n2. **Windows**: åŒå‡»è¿è¡Œ \`.exe\` æ–‡ä»¶\n3. **macOS**: æ‰“å¼€ç»ˆç«¯ï¼Œæ‹–æ‹½æ–‡ä»¶åˆ°ç»ˆç«¯çª—å£ï¼Œç„¶åæŒ‰å›è½¦\n4. **Linux**: åœ¨ç»ˆç«¯ä¸­è¿è¡Œ \`./filename\`\n5. æŒ‰ç…§æç¤ºè¾“å…¥è´¦å·ä¿¡æ¯ï¼Œé€‰æ‹©éœ€è¦çš„åŠŸèƒ½å¼€å§‹ä½¿ç”¨\n\n### ğŸ’¡ macOS ä½¿ç”¨æç¤º\n- ä¸‹è½½åå¦‚æœå‡ºç°æƒé™é”™è¯¯ï¼Œå…ˆè¿è¡Œ: \`chmod +x filename\`\n- ç„¶åç›´æ¥æ‹–æ‹½æ–‡ä»¶åˆ°ç»ˆç«¯çª—å£å³å¯è¿è¡Œ\n- æˆ–è€…åœ¨ç»ˆç«¯ä¸­ cd åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œç„¶åè¿è¡Œ \`./filename\`"
          
          echo -e "$changelog" > changelog.txt

      - name: ğŸš€ åˆ›å»ºå¤šå¹³å°å‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: "ğŸš€ Release ${{github.ref_name}}"
          body_path: changelog.txt
          files: |
            release-files/*
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: æ›´æ–° README å‘å¸ƒé“¾æ¥
      #   run: |
      #     echo "ğŸ“ æ›´æ–° README.md ä¸­çš„ä¸‹è½½é“¾æ¥..."
          
      #     # æ›´æ–° README.md ä¸­çš„ä¸‹è½½é“¾æ¥
      #     sed -i "s|https://github.com/11273/mooc-work-answer/releases/latest|${{ steps.create_release.outputs.url }}|g" README.md
          
      #     # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      #     if git diff --quiet README.md; then
      #       echo "â„¹ï¸ README.md æ— éœ€æ›´æ–°"
      #     else
      #       echo "âœ… README.md å·²æ›´æ–°"
      #       git config --global user.name "ğŸ¤– GitHub Actions"
      #       git config --global user.email "actions@github.com"
      #       git add README.md
      #       git commit -m "ğŸ“ æ›´æ–° README.md å‘å¸ƒé“¾æ¥è‡³ ${{github.ref_name}}"
      #     fi

      # - name: æ¨é€æ›´æ”¹åˆ°ä»“åº“
      #   if: success()
      #   run: |
      #     git config --global user.name "ğŸ¤– GitHub Actions"
      #     git config --global user.email "actions@github.com"
          
      #     # å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹é¿å…å†²çª
      #     git pull origin main --rebase || true
          
      #     # å¦‚æœæœ‰æ›´æ”¹åˆ™æ¨é€
      #     if ! git diff --quiet HEAD~1 HEAD; then
      #       git push https://${{ secrets.PAT_TOKEN }}@github.com/11273/mooc-work-answer.git main
      #       echo "âœ… æˆåŠŸæ¨é€æ›´æ”¹åˆ°ä»“åº“"
      #     else
      #       echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ¨é€çš„æ›´æ”¹"
      #     fi
